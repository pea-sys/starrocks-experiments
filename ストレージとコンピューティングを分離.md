# ストレージとコンピューティングを分離

https://docs.starrocks.io/docs/quick_start/shared-data/

このチュートリアルでは以下について説明します。

- Docker コンテナで StarRocks を実行する
- オブジェクトストレージに MinIO を使用する
- 共有データ用の StarRocks の設定
- 2 つの公開データセットをロードしています
- SELECT と JOIN を使用してデータを分析する
- 基本的なデータ変換（ETL の T ）

`/etc/host`の編集

```
127.0.0.1 starrocks-cn
```

```
masami@masami-L /u/src [1]> sudo mkdir quickstart
masami@masami-L /u/src> cd quickstart

masami@masami-L /u/s/quickstart [23]> sudo curl -O https://raw.githubusercontent.com/StarRocks/demo/master/documentation-samples/qu
ickstart/docker-compose.yml
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  3683  100  3683    0     0  14947      0 --:--:-- --:--:-- --:--:-- 14971
```

### StarRocks and MinIO

```
masami@masami-L /u/s/quickstart [1]> sudo docker compose up --detach --wait --wait-timeout 120
WARN[0000] /usr/src/quickstart/docker-compose.yml: `version` is obsolete
[+] Running 32/32
 ✔ starrocks-fe Pulled                                                                          528.3s
   ✔ 3713021b0277 Pull complete                                                                  23.4s
   ✔ b9c946e93bcb Pull complete                                                                 129.4s
   ✔ f22deff7e98e Pull complete                                                                 129.4s
   ✔ 1a1c3ae3fa27 Pull complete                                                                 129.5s
   ✔ 4db3af024d49 Pull complete                                                                 129.6s
   ✔ 178f096658d8 Pull complete                                                                 523.9s
   ✔ 3709b248df5e Pull complete                                                                 523.9s
   ✔ bb2c0baa6880 Pull complete                                                                 524.0s
 ✔ minio Pulled                                                                                  14.4s
   ✔ 5f328c14e09d Pull complete                                                                   3.9s
   ✔ 2190a9eea02e Pull complete                                                                   3.9s
   ✔ 10fb451d9908 Pull complete                                                                   9.5s
   ✔ 101905a88559 Pull complete                                                                   9.8s
   ✔ 2ec0427028d3 Pull complete                                                                   9.9s
   ✔ 057503f00f5e Pull complete                                                                  10.0s
   ✔ d154a296e25d Pull complete                                                                  10.0s
   ✔ c5d5ba371aeb Pull complete                                                                  10.1s
 ✔ starrocks-cn Pulled                                                                          590.9s
   ✔ dab6abd96416 Pull complete                                                                 179.1s
   ✔ 4103a31954fc Pull complete                                                                 179.2s
   ✔ 3c0208f4af6d Pull complete                                                                 179.2s
   ✔ f45c1f740032 Pull complete                                                                 179.3s
   ✔ 4087695cc9c8 Pull complete                                                                 586.3s
   ✔ 10da7adf72ef Pull complete                                                                 586.3s
   ✔ 28a1a7f3bea8 Pull complete                                                                 586.4s
 ✔ minio_mc Pulled                                                                               57.3s
   ✔ 6ee9489baede Pull complete                                                                  34.6s
   ✔ 12931aea98d8 Pull complete                                                                  38.2s
   ✔ ea5b526947dd Pull complete                                                                  41.3s
   ✔ 6028302dd0c3 Pull complete                                                                  46.9s
   ✔ 43284d2cad03 Pull complete                                                                  52.8s
[+] Running 3/5
 ✔ Network quickstart_default       Created                                                       0.1s
 ✔ Container minio                  Healthy                                                      10.3s
 ✔ Container starrocks-fe           Healthy                                                      27.1s
 ⠙ Container quickstart-minio_mc-1  Waiting                                                      42.6s
 ⠙ Container starrocks-cn           Waiting                                                      42.5s
```

```
masami@masami-L /u/s/quickstart> sudo docker compose logs minio_mc
WARN[0000] /usr/src/quickstart/docker-compose.yml: `version` is obsolete
minio_mc-1  | Added `myminio` successfully.
minio_mc-1  | Access Key: AAAAAAAAAAAAAAAAAAAA
minio_mc-1  | Secret Key: BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
minio_mc-1  | Expiration: no-expiry
```

```
masami@masami-L /u/s/quickstart [1]> sudo docker compose exec starrocks-fe \
                                         mysql -P 9030 -h 127.0.0.1 -u root --prompt="StarRocks >
"
WARN[0000] /usr/src/quickstart/docker-compose.yml: `version` is obsolete
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 233
Server version: 5.1.0 3.2.9-63ce1bd

Copyright (c) 2000, 2024, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

StarRocks >
```

### StarRocks configuration for shared-data

MinIO アクセス キーは、StarRocks と Minio を接続するために使用されます。StarRocks が起動すると、MinIO との接続が確立され、MinIO にデフォルトのストレージ ボリュームが作成されます。

### SQL

```
StarRocks > SHOW STORAGE VOLUMES;
+------------------------+
| Storage Volume         |
+------------------------+
| builtin_storage_volume |
+------------------------+
1 row in set (0.02 sec)

StarRocks > DESC STORAGE VOLUME builtin_storage_volume\G
*************************** 1. row ***************************
     Name: builtin_storage_volume
     Type: S3
IsDefault: true
 Location: s3://starrocks
   Params: {"aws.s3.access_key":"******","aws.s3.secret_key":"******","aws.s3.endpoint":"minio:9000","aws.s3.region":"","aws.s3.use_instance_profile":"false","aws.s3.use_aws_sdk_default_behavior":"false"}
  Enabled: true
  Comment:
1 row in set (0.02 sec)
```

### Create some tables

```sql
StarRocks > CREATE DATABASE IF NOT EXISTS quickstart;
ckstart;Query OK, 0 rows affected (0.02 sec)

StarRocks > USE quickstart;
Database changed
StarRocks > CREATE TABLE IF NOT EXISTS crashdata (
    ->     CRASH_DATE DATETIME,
    ->     BOROUGH STRING,
    ->     ZIP_CODE STRING,
    ->     LATITUDE INT,
    ->     LONGITUDE INT,
    ->     LOCATION STRING,
    ->     ON_STREET_NAME STRING,
    ->     CROSS_STREET_NAME STRING,
    ->     OFF_STREET_NAME STRING,
    ->     CONTRIBUTING_FACTOR_VEHICLE_1 STRING,
    ->     CONTRIBUTING_FACTOR_VEHICLE_2 STRING,
    ->     COLLISION_ID INT,
    ->     VEHICLE_TYPE_CODE_1 STRING,
    ->     VEHICLE_TYPE_CODE_2 STRING
    -> );
Query OK, 0 rows affected (0.09 sec)
```

```sql
StarRocks > CREATE TABLE IF NOT EXISTS weatherdata (
    ->     DATE DATETIME,
    ->     NAME STRING,
    ->     HourlyDewPointTemperature STRING,
    ->     HourlyDryBulbTemperature STRING,
    ->     HourlyPrecipitation STRING,
    ->     HourlyPresentWeatherType STRING,
    ->     HourlyPressureChange STRING,
    ->     HourlyPressureTendency STRING,
    ->     HourlyRelativeHumidity STRING,
    ->     HourlySkyConditions STRING,
    ->     HourlyVisibility STRING,
    ->     HourlyWetBulbTemperature STRING,
    ->     HourlyWindDirection STRING,
    ->     HourlyWindGustSpeed STRING,
    ->     HourlyWindSpeed STRING
    -> );
Query OK, 0 rows affected (0.09 sec)
```

### Load two datasets

```
root@masami-L /u/s/quickstart# sudo curl --location-trusted -u root             \
                                       -T ./NYPD_Crash_Data.csv                \
                                       -H "label:crashdata-0"                  \
                                       -H "column_separator:,"                 \
                                       -H "skip_header:1"                      \
                                       -H "enclose:\""                         \
                                       -H "max_filter_ratio:1"                 \
                                       -H "columns:tmp_CRASH_DATE, tmp_CRASH_TIME, CRASH_DATE=str_to_da
te(concat_ws(' ', tmp_CRASH_DATE, tmp_CRASH_TIME), '%m/%d/%Y %H:%i'),BOROUGH,ZIP_CODE,LATITUDE,LONGITUD
E,LOCATION,ON_STREET_NAME,CROSS_STREET_NAME,OFF_STREET_NAME,NUMBER_OF_PERSONS_INJURED,NUMBER_OF_PERSONS
_KILLED,NUMBER_OF_PEDESTRIANS_INJURED,NUMBER_OF_PEDESTRIANS_KILLED,NUMBER_OF_CYCLIST_INJURED,NUMBER_OF_
CYCLIST_KILLED,NUMBER_OF_MOTORIST_INJURED,NUMBER_OF_MOTORIST_KILLED,CONTRIBUTING_FACTOR_VEHICLE_1,CONTR
IBUTING_FACTOR_VEHICLE_2,CONTRIBUTING_FACTOR_VEHICLE_3,CONTRIBUTING_FACTOR_VEHICLE_4,CONTRIBUTING_FACTO
R_VEHICLE_5,COLLISION_ID,VEHICLE_TYPE_CODE_1,VEHICLE_TYPE_CODE_2,VEHICLE_TYPE_CODE_3,VEHICLE_TYPE_CODE_
4,VEHICLE_TYPE_CODE_5" \
                                       -XPUT http://localhost:8030/api/quickstart/crashdata/_stream_loa
d
Enter host password for user 'root':
{
    "TxnId": 3,
    "Label": "crashdata-0",
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 423726,
    "NumberLoadedRows": 423725,
    "NumberFilteredRows": 1,
    "NumberUnselectedRows": 0,
    "LoadBytes": 96227746,
    "LoadTimeMs": 2808,
    "BeginTxnTimeMs": 30,
    "StreamLoadPlanTimeMs": 202,
    "ReadDataTimeMs": 1547,
    "WriteDataTimeMs": 2417,
    "CommitAndPublishTimeMs": 158,
    "ErrorURL": "http://starrocks-cn:8040/api/_load_error_log?file=error_log_f74974e4125213b3_fe514628e4285699"
}⏎
```

```
root@masami-L /u/s/quickstart# sudo curl --location-trusted -u root             \
                                       -T ./72505394728.csv                    \
                                       -H "label:weather-0"                    \
                                       -H "column_separator:,"                 \
                                       -H "skip_header:1"                      \
                                       -H "enclose:\""                         \
                                       -H "max_filter_ratio:1"                 \
                                       -H "columns: STATION, DATE, LATITUDE, LONGITUDE, ELEVATION, NAME
, REPORT_TYPE, SOURCE, HourlyAltimeterSetting, HourlyDewPointTemperature, HourlyDryBulbTemperature, Hou
rlyPrecipitation, HourlyPresentWeatherType, HourlyPressureChange, HourlyPressureTendency, HourlyRelativ
eHumidity, HourlySkyConditions, HourlySeaLevelPressure, HourlyStationPressure, HourlyVisibility, Hourly
WetBulbTemperature, HourlyWindDirection, HourlyWindGustSpeed, HourlyWindSpeed, Sunrise, Sunset, DailyAv
erageDewPointTemperature, DailyAverageDryBulbTemperature, DailyAverageRelativeHumidity, DailyAverageSea
LevelPressure, DailyAverageStationPressure, DailyAverageWetBulbTemperature, DailyAverageWindSpeed, Dail
yCoolingDegreeDays, DailyDepartureFromNormalAverageTemperature, DailyHeatingDegreeDays, DailyMaximumDry
BulbTemperature, DailyMinimumDryBulbTemperature, DailyPeakWindDirection, DailyPeakWindSpeed, DailyPreci
pitation, DailySnowDepth, DailySnowfall, DailySustainedWindDirection, DailySustainedWindSpeed, DailyWea
ther, MonthlyAverageRH, MonthlyDaysWithGT001Precip, MonthlyDaysWithGT010Precip, MonthlyDaysWithGT32Temp
, MonthlyDaysWithGT90Temp, MonthlyDaysWithLT0Temp, MonthlyDaysWithLT32Temp, MonthlyDepartureFromNormalA
verageTemperature, MonthlyDepartureFromNormalCoolingDegreeDays, MonthlyDepartureFromNormalHeatingDegree
Days, MonthlyDepartureFromNormalMaximumTemperature, MonthlyDepartureFromNormalMinimumTemperature, Month
lyDepartureFromNormalPrecipitation, MonthlyDewpointTemperature, MonthlyGreatestPrecip, MonthlyGreatestP
recipDate, MonthlyGreatestSnowDepth, MonthlyGreatestSnowDepthDate, MonthlyGreatestSnowfall, MonthlyGrea
testSnowfallDate, MonthlyMaxSeaLevelPressureValue, MonthlyMaxSeaLevelPressureValueDate, MonthlyMaxSeaLe
velPressureValueTime, MonthlyMaximumTemperature, MonthlyMeanTemperature, MonthlyMinSeaLevelPressureValu
e, MonthlyMinSeaLevelPressureValueDate, MonthlyMinSeaLevelPressureValueTime, MonthlyMinimumTemperature,
 MonthlySeaLevelPressure, MonthlyStationPressure, MonthlyTotalLiquidPrecipitation, MonthlyTotalSnowfall
, MonthlyWetBulb, AWND, CDSD, CLDD, DSNW, HDSD, HTDD, NormalsCoolingDegreeDay, NormalsHeatingDegreeDay,
 ShortDurationEndDate005, ShortDurationEndDate010, ShortDurationEndDate015, ShortDurationEndDate020, Sh
ortDurationEndDate030, ShortDurationEndDate045, ShortDurationEndDate060, ShortDurationEndDate080, Short
DurationEndDate100, ShortDurationEndDate120, ShortDurationEndDate150, ShortDurationEndDate180, ShortDur
ationPrecipitationValue005, ShortDurationPrecipitationValue010, ShortDurationPrecipitationValue015, Sho
rtDurationPrecipitationValue020, ShortDurationPrecipitationValue030, ShortDurationPrecipitationValue045
, ShortDurationPrecipitationValue060, Shor"columns: STATION, DATE, LATITUDE, LONGITUDE, ELEVATION, NAME
ue100, ShortDurationPrecip
itationValue120, ShortDurationPrecipitationValue150, ShortDurationPrecipitati
onValue180, REM, Backup Direction, BackupDistance, BackupDistanceUnit, BackupElements, BackupElevation,
BackupEquipment, BackupLatitude, BackupLongitude, BackupName, WindEquipmentChangeDate"       \ -XPUT http://localhost:8030
 \
 -XPUT http://localhost:8030
 /api/quickstart/weatherdata/_stream_load

Enter host password for user 'root':
{
    "TxnId": 5,
    "Label": "weather-0",
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 22931,
    "NumberLoadedRows": 22931,
    "NumberFilteredRows": 0,
    "NumberUnselectedRows": 0,
    "LoadBytes": 15558550,
    "LoadTimeMs": 296,
    "BeginTxnTimeMs": 0,
    "StreamLoadPlanTimeMs": 5,
    "ReadDataTimeMs": 103,
    "WriteDataTimeMs": 265,
    "CommitAndPublishTimeMs": 24
}⏎
```

### Answer some questions

ニューヨーク市では 1 時間あたり何件の事故が起きていますか

```sql
StarRocks > USE quickstart;
Database changed
StarRocks > SELECT COUNT(*),
    ->        date_trunc("hour", crashdata.CRASH_DATE) AS Time
    -> FROM crashdata
    -> GROUP BY Time
    -> ORDER BY Time ASC
    -> LIMIT 200;
+----------+---------------------+
| count(*) | Time                |
+----------+---------------------+
|       14 | 2014-01-01 00:00:00 |
|       13 | 2014-01-01 01:00:00 |
・・・
|       14 | 2014-01-09 07:00:00 |
|       55 | 2014-01-09 08:00:00 |
+----------+---------------------+
200 rows in set (0.18 sec)
```

ニューヨークの平均気温はどれくらいですか

```sql
StarRocks > SELECT avg(HourlyDryBulbTemperature),
    ->        date_trunc("hour", weatherdata.DATE) AS Time
    -> FROM weatherdata
    -> GROUP BY Time
    -> ORDER BY Time ASC
    -> LIMIT 100;
+-------------------------------+---------------------+
| avg(HourlyDryBulbTemperature) | Time                |
+-------------------------------+---------------------+
|                            25 | 2014-01-01 00:00:00 |
|                            25 | 2014-01-01 01:00:00 |
・・・
|                            27 | 2014-01-05 02:00:00 |
|                            28 | 2014-01-05 03:00:00 |
+-------------------------------+---------------------+
100 rows in set (0.10 sec)
```

視界が悪いとき、ニューヨークで運転するのは安全ですか

```sql
StarRocks > SELECT COUNT(DISTINCT c.COLLISION_ID) AS Crashes,
    ->        truncate(avg(w.HourlyDryBulbTemperature), 1) AS Temp_F,
    ->        truncate(avg(w.HourlyVisibility), 2) AS Visibility,
    ->        max(w.HourlyPrecipitation) AS Precipitation,
    ->        date_format((date_trunc("hour", c.CRASH_DATE)), '%d %b %Y %H:%i') AS Hour
    -> FROM crashdata c
    -> LEFT JOIN weatherdata w
    -> ON date_trunc("hour", c.CRASH_DATE)=date_trunc("hour", w.DATE)
    -> WHERE w.HourlyVisibility BETWEEN 0.0 AND 1.0
    -> GROUP BY Hour
    -> ORDER BY Crashes DESC
    -> LIMIT 100;
+---------+--------+------------+---------------+-------------------+
| Crashes | Temp_F | Visibility | Precipitation | Hour              |
+---------+--------+------------+---------------+-------------------+
|     129 |     32 |       0.25 | 0.12          | 03 Feb 2014 08:00 |
|     114 |     32 |       0.25 | 0.12          | 03 Feb 2014 09:00 |
・・・
|      37 |     39 |       0.25 | 0.25          | 18 Jan 2015 15:00 |
|      36 |     60 |       0.75 | 0.05          | 24 May 2014 16:00 |
+---------+--------+------------+---------------+-------------------+
100 rows in set (0.22 sec)
```

凍結した路面での運転はどうでしょうか

```sql
StarRocks > SELECT COUNT(DISTINCT c.COLLISION_ID) AS Crashes,
    ->        truncate(avg(w.HourlyDryBulbTemperature), 1) AS Temp_F,
    ->        truncate(avg(w.HourlyVisibility), 2) AS Visibility,
    ->        max(w.HourlyPrecipitation) AS Precipitation,
    ->        date_format((date_trunc("hour", c.CRASH_DATE)), '%d %b %Y %H:%i') AS Hour
    -> FROM crashdata c
    -> LEFT JOIN weatherdata w
    -> ON date_trunc("hour", c.CRASH_DATE)=date_trunc("hour", w.DATE)
    -> WHERE w.HourlyDryBulbTemperature BETWEEN 0.0 AND 40.5
    -> GROUP BY Hour
    -> ORDER BY Crashes DESC
    -> LIMIT 100;
+---------+--------+------------+---------------+-------------------+
| Crashes | Temp_F | Visibility | Precipitation | Hour              |
+---------+--------+------------+---------------+-------------------+
|     192 |     34 |        1.5 | 0.09          | 18 Jan 2015 08:00 |
|     170 |     21 |       NULL |               | 21 Jan 2014 10:00 |
・・・
|      55 |     24 |          9 | 0.00          | 06 Mar 2015 11:00 |
|      55 |     21 |         10 | 0.00          | 23 Feb 2015 08:00 |
+---------+--------+------------+---------------+-------------------+
100 rows in set (0.17 sec)
```

minio は下記の UI アドレスからアクセス可

```
root@masami-L /u/s/quickstart# sudo docker logs minio
INFO: Formatting 1st pool, 1 set(s), 1 drives per set.
INFO: WARNING: Host local has more than 0 drives of set. A host failure will result in data becoming unavailable.
MinIO Object Storage Server
Copyright: 2015-2024 MinIO, Inc.
License: GNU AGPLv3 - https://www.gnu.org/licenses/agpl-3.0.html
Version: RELEASE.2024-07-26T20-48-21Z (go1.22.5 linux/amd64)

API: http://172.21.0.2:9000  http://127.0.0.1:9000
WebUI: http://172.21.0.2:9001 http://127.0.0.1:9001
```

![miniio](https://github.com/user-attachments/assets/c4182dde-fada-4e64-8f5b-93e7a40efeba)
